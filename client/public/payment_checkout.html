<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Compra - WeedsmokersPass</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        #form-checkout {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .container {
            height: 40px;
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            background-color: white;
            transition: all 0.2s;
        }
        .container:focus-within {
            border-color: #22c55e;
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.25);
        }
        .input-text {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
            transition: all 0.2s;
        }
        .input-text:focus {
            outline: none;
            border-color: #22c55e;
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.25);
        }
        .progress-bar {
            width: 100%;
            -webkit-appearance: none;
            appearance: none;
        }
        .progress-bar::-webkit-progress-bar {
            background-color: #e5e7eb;
            border-radius: 9999px;
        }
        .progress-bar::-webkit-progress-value {
            background-color: #22c55e;
            border-radius: 9999px;
            transition: width 0.3s;
        }
        .progress-bar::-moz-progress-bar {
            background-color: #22c55e;
            border-radius: 9999px;
        }
        .payment-button-selected {
            border-color: #3b82f6; /* azul-500 */
            background-color: #eff6ff; /* azul-50 */
            color: #1d4ed8; /* azul-700 */
        }
        .payment-button-unselected {
            border-color: #d1d5db; /* cinza-300 */
            background-color: #ffffff;
            color: #6b7280; /* cinza-500 */
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="payment-card" class="bg-white rounded-xl shadow-lg p-8 w-full max-w-md transform transition-all duration-300">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">Finalizar Compra</h1>
        <p id="amount-display" class="text-lg font-semibold text-center text-green-600 mb-6">Carregando...</p>
        
        <form id="form-checkout">
            <label class="block text-sm font-medium text-gray-700 mb-1">Método de Pagamento</label>
            <div class="flex gap-4 mb-4">
                <button id="credit-card-button" type="button" class="flex-1 flex items-center justify-center gap-2 py-3 px-4 border rounded-lg shadow-sm font-semibold transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 payment-button-selected">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 0 0 2.25-2.25V6.75A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25v10.5A2.25 2.25 0 0 0 4.5 19.5Z" />
                    </svg>
                    <span>Cartão de crédito</span>
                </button>
                <button id="pix-button" type="button" class="flex-1 flex items-center justify-center gap-2 py-3 px-4 border rounded-lg shadow-sm font-semibold transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 payment-button-unselected">
                    <svg class="" width="23px" height="22px" viewBox="0 0 22 23" fill="var(--gray-500)" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" data-v-5f3500ff=""><path d="M5.19223 5.24323C6.06969 5.24323 6.89487 5.58498 7.51525 6.20516L10.8818 9.57225C11.1243 9.8147 11.5202 9.81575 11.7633 9.57193L15.1175 6.21736C15.738 5.59718 16.5632 5.25554 17.4407 5.25554H17.8447L13.5842 0.995107C12.2574 -0.331702 10.1063 -0.331702 8.77948 0.995107L4.53135 5.24323H5.19223ZM17.4406 17.108C16.5632 17.108 15.738 16.7664 15.1176 16.1462L11.7632 12.792C11.5278 12.5558 11.1173 12.5565 10.8819 12.792L7.51531 16.1585C6.89482 16.7786 6.06964 17.1202 5.19219 17.1202H4.5312L8.77943 21.3686C10.1062 22.6953 12.2574 22.6953 13.5842 21.3686L17.8447 17.108H17.4406ZM18.794 6.20484L21.3686 8.77947C22.6954 10.1062 22.6954 12.2573 21.3686 13.5842L18.7941 16.1587C18.7373 16.1359 18.6761 16.1218 18.6112 16.1218H17.4407C16.8354 16.1218 16.243 15.8764 15.8154 15.4484L12.4611 12.0945C11.8532 11.4859 10.7925 11.4862 10.184 12.0942L6.81744 15.4607C6.38976 15.8886 5.79746 16.134 5.19222 16.134H3.75286C3.69154 16.134 3.634 16.1486 3.57983 16.169L0.995108 13.5842C-0.331703 12.2573 -0.331703 10.1062 0.995108 8.77947L3.57994 6.19464C3.63411 6.21504 3.69154 6.22956 3.75286 6.22956H5.19222C5.79746 6.22956 6.38976 6.47496 6.81744 6.90285L10.1843 10.2697C10.4982 10.5833 10.9103 10.7404 11.3227 10.7404C11.7349 10.7404 12.1473 10.5833 12.4611 10.2694L15.8154 6.91505C16.243 6.48716 16.8354 6.24176 17.4407 6.24176H18.6112C18.676 6.24176 18.7373 6.22756 18.794 6.20484Z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                    <span>Pix</span>
                </button>
            </div>
            
            <div class="flex flex-col gap-2">
                <input type="text" id="payer-name" class="input-text" placeholder="Nome Completo" />
                <div class="flex gap-4">
                    <select id="payer-identificationType" class="input-text w-1/3"></select>
                    <input type="text" id="payer-identificationNumber" class="input-text w-2/3" placeholder="Número do documento" />
                </div>
                <input type="email" id="payer-email" class="input-text" placeholder="Seu e-mail" />
            </div>

            <div id="card-form-section" class="flex flex-col gap-2">
                <div id="form-checkout__cardNumber" class="container"></div>
                <div class="flex gap-4">
                    <div id="form-checkout__expirationDate" class="container w-1/2"></div>
                    <div id="form-checkout__securityCode" class="container w-1/2"></div>
                </div>
                <select id="form-checkout__issuer" class="input-text"></select>
                <select id="form-checkout__installments" class="input-text"></select>
            </div>
            
            <div id="card-error-message" class="text-red-500 text-sm font-medium mt-2"></div>

            <div id="pix-display" class="hidden text-center">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Pagamento Pix</h2>
                <img id="qr-code-image" class="mx-auto rounded-lg mb-4 shadow-md w-full max-w-xs" />
                
                <label for="pix-copy-paste" class="block text-sm font-medium text-gray-700 text-left">Copiar Código Pix:</label>
                <div class="mt-1 flex rounded-md shadow-sm">
                    <input type="text" id="pix-copy-paste" class="flex-1 block w-full rounded-l-lg sm:text-sm border-gray-300 p-2 text-gray-700 font-mono" readonly/>
                    <button id="copy-button" type="button" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-r-lg shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                        Copiar
                    </button>
                </div>
                <div id="copy-message" class="mt-2 text-sm text-center text-green-600 opacity-0 transition-opacity duration-300">Copiado!</div>

                <p class="text-xs text-gray-500 mt-4">Este QR Code expira em 15 minutos. Realize o pagamento em seu Internet Banking ou app Pix.</p>
            </div>

            <button type="submit" id="form-checkout__submit" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-green-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 mt-4">
                Pagar Agora
            </button>
            <progress value="0" class="progress-bar hidden mt-4"></progress>
        </form>
        
        <div id="status-message" class="mt-6 text-center text-sm font-medium"></div>
    </div>

    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const statusMessage = document.getElementById('status-message');
            const submitButton = document.getElementById('form-checkout__submit');
            const progressBar = document.querySelector(".progress-bar");
            const form = document.getElementById('form-checkout');
            const amountDisplay = document.getElementById('amount-display');
            const cardFormSection = document.getElementById('card-form-section');
            const pixDisplaySection = document.getElementById('pix-display');
            
            const creditCardButton = document.getElementById('credit-card-button');
            const pixButton = document.getElementById('pix-button');
            const payerName = document.getElementById('payer-name');
            const payerIdentificationType = document.getElementById('payer-identificationType');
            const payerIdentificationNumber = document.getElementById('payer-identificationNumber');
            const payerEmail = document.getElementById('payer-email');
            const cardErrorMessage = document.getElementById('card-error-message');

            const urlParams = new URLSearchParams(window.parent.location.search);
            const userId = urlParams.get('userId');
            const userEmail = urlParams.get('userEmail');
            const amount = urlParams.get('amount');

            if (!userId || !userEmail || !amount) {
                statusMessage.className = "mt-6 text-center text-red-500";
                statusMessage.textContent = 'Erro: Faltam informações do usuário ou valor do pagamento. Por favor, volte e tente novamente.';
                submitButton.disabled = true;
                return;
            }

            payerEmail.value = userEmail;
            amountDisplay.textContent = `WeedsmokersPass - R$${parseFloat(amount).toFixed(2).replace('.', ',')}`;

            const PUBLIC_KEY = 'APP_USR-b01cb2b1-0952-45b9-bb3c-b72588a7b205'; 
            
            const mp = new MercadoPago(PUBLIC_KEY, { locale: 'pt-BR' });

            const cardForm = mp.cardForm({
                amount: amount,
                iframe: true,
                form: {
                    id: "form-checkout",
                    cardNumber: { id: "form-checkout__cardNumber", placeholder: "Número do cartão" },
                    expirationDate: { id: "form-checkout__expirationDate", placeholder: "MM/YY" },
                    securityCode: { id: "form-checkout__securityCode", placeholder: "Cód. de segurança" },
                    cardholderName: { id: "payer-name", placeholder: "Nome Completo" },
                    issuer: { id: "form-checkout__issuer", placeholder: "Banco emissor" },
                    installments: { id: "form-checkout__installments", placeholder: "Parcelas" },
                    identificationType: { id: "payer-identificationType", placeholder: "Tipo de documento" },
                    identificationNumber: { id: "payer-identificationNumber", placeholder: "Número do documento" },
                    cardholderEmail: { id: "payer-email", placeholder: "E-mail" },
                },
                callbacks: {
                    onFormMounted: error => {
                        if (error) return console.warn("Form Mounted handling error: ", error);
                        console.log("Form mounted");
                    },
                    onFetching: (resource) => {
                        console.log("Fetching resource: ", resource);
                        progressBar.classList.remove('hidden');
                        progressBar.removeAttribute("value");
                        return () => {
                            progressBar.setAttribute("value", "0");
                            progressBar.classList.add('hidden');
                        };
                    },
                    onSubmit: (event) => {
                        // Impedir que o cardForm faça sua validação automática
                        // se o método de pagamento selecionado for Pix.
                        if (selectedPaymentMethod === 'pix') {
                            event.preventDefault();
                            processPixPayment();
                        }
                    }
                },
            });

            // Lógica para alternar entre métodos de pagamento
            let selectedPaymentMethod = 'credit_card';

            function togglePaymentSections() {
                pixDisplaySection.classList.add('hidden');
                submitButton.classList.remove('hidden');
                cardErrorMessage.textContent = ''; // Limpa a mensagem de erro

                if (selectedPaymentMethod === 'pix') {
                    cardFormSection.classList.add('hidden');
                    submitButton.textContent = 'Gerar Pix';
                    pixButton.classList.add('payment-button-selected');
                    pixButton.classList.remove('payment-button-unselected');
                    creditCardButton.classList.remove('payment-button-selected');
                    creditCardButton.classList.add('payment-button-unselected');
                } else {
                    cardFormSection.classList.remove('hidden');
                    submitButton.textContent = 'Pagar Agora';
                    creditCardButton.classList.add('payment-button-selected');
                    creditCardButton.classList.remove('payment-button-unselected');
                    pixButton.classList.remove('payment-button-selected');
                    pixButton.classList.add('payment-button-unselected');
                }
            }
            
            creditCardButton.addEventListener('click', () => {
                selectedPaymentMethod = 'credit_card';
                togglePaymentSections();
            });

            pixButton.addEventListener('click', () => {
                selectedPaymentMethod = 'pix';
                togglePaymentSections();
            });

            // O Listener de submit padrão agora apenas lida com a lógica de cartão.
            // A lógica de Pix foi movida para o callback onSubmit do cardForm.
            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                submitButton.disabled = true;
                submitButton.textContent = 'Processando...';
                cardErrorMessage.textContent = '';

                if (selectedPaymentMethod === 'credit_card') {
                    await processCardPayment();
                } else {
                    // O processamento de Pix já é tratado no callback onSubmit
                    // para evitar a validação do cardForm.
                    await processPixPayment();
                }
            });

            // Lógica para processar o pagamento com cartão
            async function processCardPayment() {
                try {
                    const cardData = await new Promise((resolve, reject) => {
                        cardForm.createCardToken({
                            success: (token) => resolve({ token: token.id }),
                            error: (error) => reject(error)
                        });
                    });

                    // Separar nome e sobrenome do campo único
                    const nameParts = payerName.value.trim().split(' ');
                    const firstName = nameParts.shift() || '';
                    const lastName = nameParts.join(' ') || '';
                    
                    const paymentData = {
                        token: cardData.token,
                        userId: userId,
                        email: payerEmail.value,
                        amount: parseFloat(amount),
                        description: "WeedsmokersPass",
                        installments: Number(document.getElementById('form-checkout__installments').value),
                        paymentMethodId: document.getElementById('form-checkout__issuer').value,
                        identificationType: payerIdentificationType.value,
                        identificationNumber: payerIdentificationNumber.value,
                        payer: {
                            first_name: firstName,
                            last_name: lastName,
                        },
                        items: [{
                            id: "WEEDSPASS-01",
                            title: "WeedsmokersPass",
                            description: "Assinatura digital para acesso exclusivo ao conteúdo e comunidade Weedsmokers Connection.",
                            category_id: "services", 
                            quantity: 1,
                            unit_price: parseFloat(amount),
                        }],
                        // Removido `deviceId`, o SDK do MP V2 cuida disso automaticamente
                    };

                    const response = await fetch('https://api.weedsmokersconnection.com/api/mercadopago/process-payment', {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(paymentData),
                    });

                    const result = await response.json();

                    if (response.ok) {
                        statusMessage.className = "mt-6 text-center text-green-500";
                        statusMessage.textContent = 'Pagamento aprovado! Redirecionando...';
                        window.location.href = `${window.location.origin}/login`;
                    } else {
                        statusMessage.className = "mt-6 text-center text-red-500";
                        statusMessage.textContent = result.message || 'Erro ao processar o pagamento. Verifique os dados e tente novamente.';
                    }
                } catch (error) {
                    console.error("Erro na requisição ou validação:", error);
                    let errorMessage = 'Erro ao processar o pagamento. Verifique os dados e tente novamente.';
                    if (Array.isArray(error)) {
                        errorMessage = error.map(e => e.message).join(' | ');
                    }
                    cardErrorMessage.textContent = `Erro: ${errorMessage}`;
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Pagar Agora';
                }
            }

            // Lógica para processar o pagamento Pix
            async function processPixPayment() {
                submitButton.textContent = 'Gerando Pix...';
                try {
                    const identificationNumberCleaned = payerIdentificationNumber.value.replace(/\D/g, '');

                    const pixData = {
                        userId: userId,
                        amount: parseFloat(amount),
                        email: payerEmail.value,
                        firstName: payerName.value.split(' ')[0],
                        lastName: payerName.value.split(' ').slice(1).join(' '),
                        identificationType: payerIdentificationType.value,
                        identificationNumber: identificationNumberCleaned,
                        items: [{
                            id: "WEEDSPASS-01",
                            title: "WeedsmokersPass",
                            description: "Assinatura digital para acesso exclusivo ao conteúdo e comunidade Weedsmokers Connection.",
                            category_id: "services", 
                            quantity: 1,
                            unit_price: parseFloat(amount),
                        }],
                        // Removido `deviceId`, o SDK do MP V2 cuida disso automaticamente
                    };
                    
                    const response = await fetch('https://api.weedsmokersconnection.com/api/mercadopago/process-pix-payment', {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(pixData),
                    });

                    const result = await response.json();

                    if (response.ok) {
                        if (result.status === "pending" && result.status_detail === "pending_waiting_transfer") {
                            renderPix(result);
                        } else {
                            statusMessage.className = "mt-6 text-center text-red-500";
                            statusMessage.textContent = 'Erro ao gerar o Pix. Tente novamente.';
                        }
                    } else {
                        statusMessage.className = "mt-6 text-center text-red-500";
                        statusMessage.textContent = result.message || 'Erro ao processar o pagamento Pix. Verifique os dados e tente novamente.';
                    }
                } catch (error) {
                    console.error("Erro na requisição:", error);
                    statusMessage.className = "mt-6 text-center text-red-500";
                    statusMessage.textContent = 'Erro de rede. Verifique sua conexão e tente novamente.';
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Gerar Pix';
                }
            }

            // Lógica para exibir QR Code e código Pix
            function renderPix(response) {
                const qrImage = document.getElementById('qr-code-image');
                const qrCopyPaste = document.getElementById('pix-copy-paste');
                
                qrImage.src = `data:image/jpeg;base64,${response.point_of_interaction.transaction_data.qr_code_base64}`;
                qrCopyPaste.value = response.point_of_interaction.transaction_data.qr_code;

                cardFormSection.classList.add('hidden');
                pixDisplaySection.classList.remove('hidden');
                submitButton.classList.add('hidden');
                statusMessage.textContent = 'Escaneie o QR Code para pagar.';
            }

            // Lógica para copiar o código Pix
            document.getElementById('copy-button').addEventListener('click', () => {
                const copyInput = document.getElementById('pix-copy-paste');
                copyInput.select();
                copyInput.setSelectionRange(0, 99999);
                try {
                    navigator.clipboard.writeText(copyInput.value);
                    const copyMessage = document.getElementById('copy-message');
                    copyMessage.textContent = 'Copiado!';
                    copyMessage.classList.remove('opacity-0');
                    setTimeout(() => copyMessage.classList.add('opacity-0'), 2000);
                } catch (err) {
                    console.error('Erro ao copiar o texto:', err);
                }
            });

            // Lógica para preencher os tipos de documento nos selects
            async function getIdentificationTypes() {
                try {
                    const identificationTypes = await mp.getIdentificationTypes();
                    createSelectOptions(payerIdentificationType, identificationTypes);
                } catch (e) {
                    console.error('Error getting identificationTypes: ', e);
                }
            }

            function createSelectOptions(elem, options, labelsAndKeys = { label: "name", value: "id" }) {
                const { label, value } = labelsAndKeys;
                elem.options.length = 0;
                const tempOptions = document.createDocumentFragment();
                options.forEach(option => {
                    const optValue = option[value];
                    const optLabel = option[label];
                    const opt = document.createElement('option');
                    opt.value = optValue;
                    opt.textContent = optLabel;
                    tempOptions.appendChild(opt);
                });
                elem.appendChild(tempOptions);
            }

            togglePaymentSections();
            getIdentificationTypes();
        });
    </script>
</body>
</html>