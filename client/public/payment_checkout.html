<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Compra - WeedsmokersPass</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        #form-checkout {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .container {
            height: 40px;
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            background-color: white;
            transition: all 0.2s;
        }
        .container:focus-within {
            border-color: #22c55e;
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.25);
        }
        .input-text {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
            transition: all 0.2s;
        }
        .input-text:focus {
            outline: none;
            border-color: #22c55e;
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.25);
        }
        .progress-bar {
            width: 100%;
            -webkit-appearance: none;
            appearance: none;
        }
        .progress-bar::-webkit-progress-bar {
            background-color: #e5e7eb;
            border-radius: 9999px;
        }
        .progress-bar::-webkit-progress-value {
            background-color: #22c55e;
            border-radius: 9999px;
            transition: width 0.3s;
        }
        .progress-bar::-moz-progress-bar {
            background-color: #22c55e;
            border-radius: 9999px;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="payment-card" class="bg-white rounded-xl shadow-lg p-8 w-full max-w-md transform transition-all duration-300">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">Finalizar Compra</h1>
        <p id="amount-display" class="text-lg font-semibold text-center text-green-600 mb-6">Carregando...</p>
        
        <form id="form-checkout">
            <div id="form-checkout__cardNumber" class="container"></div>
            <div class="flex gap-4">
                <div id="form-checkout__expirationDate" class="container w-1/2"></div>
                <div id="form-checkout__securityCode" class="container w-1/2"></div>
            </div>
            <input type="text" id="form-checkout__cardholderName" class="input-text" placeholder="Nome Completo (igual no cartão)" />
            <select id="form-checkout__issuer" class="input-text"></select>
            <select id="form-checkout__installments" class="input-text"></select>
            <div class="flex gap-4">
                <select id="form-checkout__identificationType" class="input-text w-1/3"></select>
                <input type="text" id="form-checkout__identificationNumber" class="input-text w-2/3" placeholder="Número do documento" />
            </div>
            <input type="email" id="form-checkout__cardholderEmail" class="input-text" placeholder="Seu e-mail" disabled />

            <button type="submit" id="form-checkout__submit" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-green-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 mt-4">
                Pagar Agora
            </button>
            <progress value="0" class="progress-bar hidden mt-4"></progress>
        </form>
        
        <div id="status-message" class="mt-6 text-center text-sm font-medium"></div>
    </div>

    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const statusMessage = document.getElementById('status-message');
            const submitButton = document.getElementById('form-checkout__submit');
            const progressBar = document.querySelector(".progress-bar");
            const userEmailInput = document.getElementById('form-checkout__cardholderEmail');
            const form = document.getElementById('form-checkout');
            const amountDisplay = document.getElementById('amount-display');

            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('userId');
            const userEmail = urlParams.get('userEmail');
            const amount = urlParams.get('amount'); // <-- LENDO O NOVO PARÂMETRO DA URL

            if (!userId || !userEmail || !amount) {
                statusMessage.className = "mt-6 text-center text-red-500";
                statusMessage.textContent = 'Erro: Faltam informações do usuário ou valor do pagamento. Por favor, volte e tente novamente.';
                submitButton.disabled = true;
                return;
            }

            userEmailInput.value = userEmail;
            amountDisplay.textContent = `WeedsmokersPass - R$${parseFloat(amount).toFixed(2).replace('.', ',')}`;

            // Substitua 'YOUR_PUBLIC_KEY' pela sua Chave Pública
            const PUBLIC_KEY = 'TEST-ecd8f16d-1187-460c-9f06-ecb3f03ca725'; 

            try {
                const mp = new MercadoPago(PUBLIC_KEY, { locale: 'pt-BR' });

                const cardForm = mp.cardForm({
                    amount: amount, // <-- PASSANDO O VALOR LIDO DA URL
                    iframe: true,
                    form: {
                        id: "form-checkout",
                        cardNumber: { id: "form-checkout__cardNumber", placeholder: "Número do cartão" },
                        expirationDate: { id: "form-checkout__expirationDate", placeholder: "MM/YY" },
                        securityCode: { id: "form-checkout__securityCode", placeholder: "Cód. de segurança" },
                        cardholderName: { id: "form-checkout__cardholderName", placeholder: "Nome completo" },
                        issuer: { id: "form-checkout__issuer", placeholder: "Banco emissor" },
                        installments: { id: "form-checkout__installments", placeholder: "Parcelas" },
                        identificationType: { id: "form-checkout__identificationType", placeholder: "Tipo de documento" },
                        identificationNumber: { id: "form-checkout__identificationNumber", placeholder: "Número do documento" },
                        cardholderEmail: { id: "form-checkout__cardholderEmail", placeholder: "E-mail" },
                    },
                    callbacks: {
                        onFormMounted: error => {
                            if (error) return console.warn("Form Mounted handling error: ", error);
                            console.log("Form mounted");
                        },
                        onSubmit: async event => {
                            event.preventDefault();
                            submitButton.disabled = true;
                            submitButton.textContent = 'Processando...';

                            const cardData = cardForm.getCardFormData();
                            
                            const paymentData = {
                                token: cardData.token,
                                userId: userId,
                                email: cardData.cardholderEmail,
                                amount: parseFloat(amount), // <-- USANDO O VALOR LIDO DA URL
                                description: "WeedsmokersPass",
                                installments: Number(cardData.installments),
                                paymentMethodId: cardData.paymentMethodId,
                                issuerId: cardData.issuerId,
                                identificationType: cardData.identificationType,
                                identificationNumber: cardData.identificationNumber,
                            };
                            
                            try {
                                // CORREÇÃO: Usar a URL completa do seu backend
                                const response = await fetch('https://api.weedsmokersconnection.com/api/mercadopago/process-payment', {
                                    method: "POST",
                                    headers: { "Content-Type": "application/json" },
                                    body: JSON.stringify(paymentData),
                                });

                                const result = await response.json();

                                if (response.ok) {
                                    statusMessage.className = "mt-6 text-center text-green-500";
                                    statusMessage.textContent = 'Pagamento aprovado! Redirecionando...';
                                    window.location.href = `${window.location.origin}/login.html`;
                                } else {
                                    statusMessage.className = "mt-6 text-center text-red-500";
                                    statusMessage.textContent = result.message || 'Erro ao processar o pagamento. Verifique os dados e tente novamente.';
                                    submitButton.disabled = false;
                                    submitButton.textContent = 'Pagar Agora';
                                }
                            } catch (error) {
                                console.error("Erro na requisição:", error);
                                statusMessage.className = "mt-6 text-center text-red-500";
                                statusMessage.textContent = 'Erro de rede. Verifique sua conexão e tente novamente.';
                                submitButton.disabled = false;
                                submitButton.textContent = 'Pagar Agora';
                            }
                        },
                        onFetching: (resource) => {
                            console.log("Fetching resource: ", resource);
                            progressBar.classList.remove('hidden');
                            progressBar.removeAttribute("value");
                            return () => {
                                progressBar.setAttribute("value", "0");
                                progressBar.classList.add('hidden');
                            };
                        }
                    },
                });
            } catch (error) {
                console.error("Erro ao inicializar o SDK do Mercado Pago:", error);
                statusMessage.className = "mt-6 text-center text-red-500";
                statusMessage.textContent = 'Erro ao carregar o formulário de pagamento. Tente novamente mais tarde.';
                submitButton.disabled = true;
            }
        });
    </script>
</body>
</html>